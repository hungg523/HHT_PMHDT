<!DOCTYPE html>
<html lang="en">

<head>
    <title>Nhà thuốc - Danh mục sản phẩm</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap&subset=vietnamese">
    <link rel="icon" href="/assets/images/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="/assets/fonts/icomoon/style.css">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/magnific-popup.css">
    <link rel="stylesheet" href="/assets/css/jquery-ui.css">
    <link rel="stylesheet" href="/assets/css/owl.carousel.min.css">
    <link rel="stylesheet" href="/assets/css/owl.theme.default.min.css">


    <link rel="stylesheet" href="/assets/css/aos.css">
    <link rel="stylesheet" href="/assets/css/popup.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
    <!-- Navbar -->
    <div class="site-wrap">
        <div class="site-navbar py-2">

            <div class="search-wrap" id="searchSection" style="display: none;">
                <div class="container">
                    <a href="#" class="search-close js-search-close" onclick="toggleSearch(false)">
                        <span class="icon-close2"></span>
                    </a>
                    <form onsubmit="searchProduct(event)">
                        <input type="text" class="form-control" id="searchInput" placeholder="Nhập tên sản phẩm...">
                    </form>
                </div>
            </div>


            <div class="container">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="logo">
                        <div class="site-logo">
                            <a href="/index.html" class="js-logo-clone">HHT <span
                                    style="color: #5eba24;">Pharmacy</span></a>
                        </div>
                    </div>

                    <div class="main-nav d-none d-lg-block">
                        <nav class="site-navigation text-right text-md-center" role="navigation">
                            <ul class="site-menu js-clone-nav d-none d-lg-block">
                                <li class="active"><a href="/index.html"><strong>Trang chủ</strong></a></li>
                                <li class="has-children">
                                    <a href="#"><strong>Danh mục</strong></a>
                                    <ul class="dropdown" id="categoryList">
                                        <!-- Danh mục hiển thị từ API -->
                                    </ul>
                                </li>
                                <li><a href="/pages/shop.html"><strong>Sản phẩm</strong></a></li>
                                <li><a href="/pages/about.html"><strong>Về chúng tôi</strong></a></li>
                                <li><a href="/pages/contact.html"><strong>Liên hệ</strong></a></li>
                            </ul>
                        </nav>
                    </div>
                    <a href="#" class="icons-btn d-inline-block js-search-open" onclick="toggleSearch(true)"><span
                            class="icon-search"></span></a>
                    <div class="icons">
                        <!-- Link mở popup Đăng nhập và Đăng ký -->
                        <div class="icons" id="accountSection">
                            <!-- Nội dung sẽ được JavaScript cập nhật -->
                            <a href="cart.html" class="icons-btn d-inline-block bag">
                                <span class="icon-shopping-bag"></span>
                                <span class="number">2</span>
                            </a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Breadcrumb -->
    <div class="bg-light py-3">
        <div class="container">
            <div class="row">
                <div class="col-md-12 mb-0">
                    <a href="/index.html">Trang chủ</a> <span class="mx-2 mb-0">/</span>
                    <strong class="text-black" id="categoryName">Thanh toán</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="site-section">
        <div class="container">
            <div class="row mb-5">
                <form class="col-md-12" method="post">
                    <div class="site-blocks-table">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="product-thumbnail">Sản phẩm</th>
                                    <th class="product-name">Tên sản phẩm</th>
                                    <th class="product-price">Giá</th>
                                    <th class="product-quantity">Số lượng</th>
                                    <th class="product-total">Tổng</th>
                                    <th class="product-remove">Xóa</th>
                                </tr>
                            </thead>
                            <tbody id="cartTableBody">
                                <!-- Hiển thị sản phẩm thông qua localStorage -->
                            </tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="row mb-3">
                        <div class="col-md-6 text-right">
                            <select id="addressSelect" class="form-control">
                                <option value="">Chọn địa chỉ</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="row">

                <div class="col-md-6">
                    <div class="row mb-5">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <button class="btn btn-primary btn-md btn-block">Cập nhật giỏ hàng</button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-md btn-block"><a href="/pages/shop.html">Tiếp tục
                                    mua sắm</a></button>
                        </div>
                    </div>


                    <div class="row">
                        <div class="col-md-12">
                            <label class="text-black h4" for="coupon">Mã giảm giá</label>
                            <p>Nhập mã phiếu sản phẩm nếu có.</p>
                        </div>
                        <div class="col-md-8 mb-3 mb-md-0">
                            <input type="text" class="form-control py-3" id="coupon" placeholder="Coupon Code">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary btn-md px-4">Áp dụng</button>
                        </div>
                    </div>
                </div>



                <div class="col-md-6 pl-5">
                    <h3 class="text-black h4 text-uppercase">Tổng thanh toán</h3>
                    <div class="row mb-3">
                        <div class="col-md-6">Subtotal</div>
                        <div class="col-md-6 text-right" id="subtotal"></div>
                    </div>
                    <div class="row">
                        <button class="btn btn-primary btn-lg btn-block" onclick="checkout()">Thanh toán</button>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <div class="site-section bg-secondary bg-image" style="background-image: url('/assets/images/bg_2.jpg');">
        <div class="container">
            <div class="row align-items-stretch">
                <div class="col-lg-6 mb-5 mb-lg-0">
                    <a href="#" class="banner-1 h-100 d-flex" style="background-image: url('/assets/images/bg_1.jpg');">
                        <div class="banner-1-inner align-self-center">
                            <h2>Pharma Products</h2>
                            <p>HHT Pharmacy cung cấp các sản phẩm dược phẩm chất lượng cao, đa dạng từ thuốc điều
                                trị bệnh, thực phẩm chức năng đến các sản phẩm chăm sóc sức khỏe. Với cam kết về an
                                toàn và hiệu quả.
                            </p>
                        </div>
                    </a>
                </div>
                <div class="col-lg-6 mb-5 mb-lg-0">
                    <a href="#" class="banner-1 h-100 d-flex" style="background-image: url('/assets/images/bg_2.jpg');">
                        <div class="banner-1-inner ml-auto  align-self-center">
                            <h2>Đánh giá bởi chuyên gia</h2>
                            <p>hương hiệu được các chuyên gia y tế đánh giá cao về độ an toàn và hiệu quả trong việc
                                hỗ trợ điều trị và chăm sóc sức khỏe..
                            </p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-lg-3 mb-4 mb-lg-0">

                    <div class="block-7">
                        <h3 class="footer-heading mb-4">Thông tin</h3>
                        <p>"Pharma cam kết mang đến các sản phẩm chăm sóc sức khỏe chất lượng, uy tín từ các
                            thương hiệu hàng đầu. Chúng tôi cung cấp đa dạng các loại thuốc, thực phẩm chức năng, và sản
                            phẩm hỗ trợ
                            sức khỏe với đội ngũ tư vấn tận tình, chuyên nghiệp. Mục tiêu của chúng tôi là luôn đồng
                            hành cùng sức
                            khỏe của bạn và gia đình."
                        </p>
                    </div>

                </div>
                <div class="col-lg-3 mx-auto mb-5 mb-lg-0">
                    <h3 class="footer-heading mb-4">Danh mục</h3>
                    <ul class="list-unstyled" id="categoryListFooter">
                        <!-- Danh mục từ API -->
                    </ul>
                </div>

                <div class="col-md-6 col-lg-3">
                    <div class="block-5 mb-5">
                        <h3 class="footer-heading mb-4">Liên hệ</h3>
                        <ul class="list-unstyled">
                            <li class="address">Đại học Trà Vinh</li>
                            <li class="phone"><a href="tel://379932119">+84379932119</a></li>
                            <li class="email">Pharma@st.tvu.edu.vn</li>
                        </ul>
                    </div>


                </div>
            </div>
            <div class="row pt-5 mt-5 text-center">
                <div class="col-md-12">
                    <p>
                        Copyright &copy;
                        <script>document.write(new Date().getFullYear());</script> All rights reserved | This website is
                        made
                        with by a group of students <a href="https://www.tvu.edu.vn/" target="_blank"
                            class="text-primary">TVU</a>
                    </p>
                </div>

            </div>
        </div>
    </footer>

    <script src="/assets/js/jquery-3.3.1.min.js"></script>
    <script src="/assets/js/jquery-ui.js"></script>
    <script src="/assets/js/popper.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/owl.carousel.min.js"></script>
    <script src="/assets/js/jquery.magnific-popup.min.js"></script>
    <script src="/assets/js/aos.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/nav.js"></script>
    <script src="/assets/js/footer.js"></script>
    <script src="/assets/js/login.js"></script>
    <script src="/assets/js/popup.js"></script>
    <script src="/assets/js/register.js"></script>
    <script src="/assets/js/cart.js"></script>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadCart();
            getCustomerIdByEmail();
            loadAddresses();
        });

        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartTableBody = document.querySelector('table tbody');

            let subtotal = 0;

            cartTableBody.innerHTML = '';
            cart.forEach(async (item) => {
                try {
                    const response = await fetch(`https://localhost:1006/get-product-detail?id=${item.productId}`);
                    const product = await response.json();
                    const price = product.discountPrice || product.regularPrice;
                    const total = price * item.quantity;
                    subtotal += total;

                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td><img src="https://localhost:1005/${product.imagePath}" alt="Product Image" class="img-fluid" width="100"></td>
                        <td>${product.productName}</td>
                        <td>${product.discountPrice ? formatCurrency(product.discountPrice) : formatCurrency(product.regularPrice)}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency((product.discountPrice || product.regularPrice) * item.quantity)}</td>
                        <td><a href="#" class="btn btn-primary btn-sm" onclick="removeFromCart(${item.productId})">X</a></td>
                    `;
                    cartTableBody.appendChild(row);

                } catch (error) {
                    console.error('Lỗi khi lấy chi tiết sản phẩm:', error);
                }
                document.getElementById('subtotal').innerText = formatCurrency(subtotal);
            });
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
        }

        function removeFromCart(productId) {
            console.log(`Đang xóa sản phẩm với ID: ${productId}`);
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const updatedCart = cart.filter(item => item.productId !== String(productId));
            localStorage.setItem('cart', JSON.stringify(updatedCart));
            const newCart = JSON.parse(localStorage.getItem('cart'));
            console.log('Giỏ hàng sau khi xóa:', newCart);

            loadCart();
        }



        let customerId;
        async function getCustomerIdByEmail() {
            const email = localStorage.getItem("userEmail");
            if (!email) return;

            try {
                const response = await fetch(`https://localhost:1006/get-customer-by-email?email=${email}`);
                if (!response.ok) throw new Error("Lỗi khi lấy thông tin khách hàng");

                const customerData = await response.json();
                customerId = customerData.id;
                return customerId;
            } catch (error) {
                console.error("Error fetching customer info:", error);
            }
        }

        async function loadAddresses() {
            if (!customerId) {
                console.error("Không có customerId để lấy danh sách địa chỉ.");
                return;
            }

            try {
                const response = await fetch(`https://localhost:1006/get-address-by-customer-id?id=${customerId}`);
                if (!response.ok) throw new Error('Không thể tải danh sách địa chỉ');

                const addresses = await response.json();
                const addressSelect = document.getElementById('addressSelect');
                addressSelect.innerHTML = ""; // Xóa các lựa chọn cũ nếu có

                addresses.forEach((address) => {
                    const option = document.createElement('option');
                    option.value = address.id; // Gán ID của địa chỉ vào value
                    option.textContent = `${address.fullName} - ${address.phone} - ${address.finalAddress}`;
                    addressSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Lỗi khi tải địa chỉ:', error);
            }
        }

        async function checkout() {
            const selectedAddressId = document.getElementById('addressSelect').value; // Lấy customerAddressId từ lựa chọn
            if (!customerId || !selectedAddressId) {
                console.error("Thiếu thông tin khách hàng hoặc địa chỉ.");
                return;
            }

            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) {
                alert('Giỏ hàng của bạn trống.');
                return;
            }

            const orderData = {
                customerId: customerId,
                orderItems: cart.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity
                })),
                customerAddressId: parseInt(selectedAddressId), // Sử dụng ID của địa chỉ đã chọn
                paymentMethod: "COD"
            };

            try {
                const response = await fetch('https://localhost:1006/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    alert('Đặt hàng thành công!');
                    localStorage.removeItem('cart');
                    window.location.href = '/index.html';
                } else {
                    alert('Đặt hàng thất bại. Vui lòng thử lại.');
                }
            } catch (error) {
                console.error('Lỗi trong quá trình thanh toán:', error);
                alert('Không thể kết nối tới máy chủ.');
            }
        }

        document.addEventListener("DOMContentLoaded", async function () {
            await getCustomerIdByEmail();
            await loadAddresses();
        });

    </script>
</body>

</html>
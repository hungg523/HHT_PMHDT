<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Nh√† Thu·ªëc - Trang ch·ªß </title>

  <link rel="stylesheet" href="assets/vendors/feather/feather.css">
  <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="assets/vendors/ti-icons/css/themify-icons.css">
  <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="assets/vendors/typicons/typicons.css">
  <link rel="stylesheet" href="assets/vendors/simple-line-icons/css/simple-line-icons.css">
  <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
  <link rel="stylesheet" href="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css">
  <link rel="stylesheet" href="assets/vendors/datatables.net-bs4/dataTables.bootstrap4.css">
  <link rel="stylesheet" type="text/css" href="assets/js/select.dataTables.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="shortcut icon" href="assets/images/favicon.png" />
</head>

<body class="with-welcome-text">
  <div class="container-scroller">
    <!-- Navbar -->
    <nav class="navbar default-layout col-lg-12 col-12 p-0 fixed-top d-flex align-items-top flex-row">
      <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
        <div class="me-3">
          <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-bs-toggle="minimize">
            <span class="icon-menu"></span>
          </button>
        </div>
        <div>
          <a class="navbar-brand brand-logo" href="index.html">
            <img src="assets/images/logo.svg" alt="logo" />
          </a>
          <a class="navbar-brand brand-logo-mini" href="index.html">
            <img src="assets/images/logo-mini.svg" alt="logo" />
          </a>
        </div>
      </div>
      <div class="navbar-menu-wrapper d-flex align-items-top">
        <ul class="navbar-nav">
          <li class="nav-item fw-semibold d-none d-lg-block ms-0">
            <h1 class="welcome-text" id="greeting"></h1>
            <h3 class="welcome-sub-text"> ƒê√¢y l√† trang qu·∫£n l√Ω nh√† thu·ªëc! </h3>
          </li>
        </ul>
      </div>
    </nav>

    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link" href="index.html">
              <i class="mdi mdi-grid-large menu-icon"></i>
              <span class="menu-title">Trang ch·ªß</span>
            </a>
          </li>
          <hr>

          <!-- Danh m·ª•c -->
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#ui-basic" aria-expanded="false"
              aria-controls="ui-basic">
              <i class="menu-icon mdi mdi-view-list"></i>
              <span class="menu-title">Danh m·ª•c</span>
              <i class="menu-arrow"></i>
            </a>
            <div class="collapse" id="ui-basic">
              <ul class="nav flex-column sub-menu">
                <li class="nav-item"> <a class="nav-link" href="/Admin/pages/category/index-category.html">Qu·∫£n l√Ω danh
                    m·ª•c</a></li>
                <li class="nav-item"> <a class="nav-link" href="/Admin/pages/category/create-category.html">T·∫°o m·ªõi danh
                    m·ª•c</a></li>
              </ul>
            </div>
          </li>

          <!-- S·∫£n ph·∫©m -->
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#product-basic" aria-expanded="false"
              aria-controls="product-basic">
              <i class="menu-icon mdi mdi-package-variant"></i>
              <span class="menu-title">S·∫£n ph·∫©m</span>
              <i class="menu-arrow"></i>
            </a>
            <div class="collapse" id="product-basic">
              <ul class="nav flex-column sub-menu">
                <li class="nav-item"> <a class="nav-link" href="/Admin/pages/product/index-product.html">Qu·∫£n l√Ω s·∫£n
                    ph·∫©m</a></li>
                <li class="nav-item"> <a class="nav-link" href="/Admin/pages/product/create-product.html">T·∫°o m·ªõi s·∫£n
                    ph·∫©m</a></li>
              </ul>
            </div>
          </li>

          <!-- ƒê∆°n h√†ng -->
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#order-basic" aria-expanded="false"
              aria-controls="order-basic">
              <i class="menu-icon mdi mdi-cart-outline"></i>
              <span class="menu-title">ƒê∆°n h√†ng</span>
              <i class="menu-arrow"></i>
            </a>
            <div class="collapse" id="order-basic">
              <ul class="nav flex-column sub-menu">
                <li class="nav-item"> <a class="nav-link" href="/Admin/pages/order/index-order.html">Qu·∫£n l√Ω ƒë∆°n
                    h√†ng</a></li>
              </ul>
            </div>
          </li>

          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#coupon-basic" aria-expanded="false"
              aria-controls="coupon-basic">
              <i class="menu-icon mdi mdi-cart-outline"></i>
              <span class="menu-title">M√£ gi·∫£m gi√°</span>
              <i class="menu-arrow"></i>
            </a>
            <div class="collapse" id="coupon-basic">
              <ul class="nav flex-column sub-menu">
                <li class="nav-item"> <a class="nav-link" href="/Admin/pages/coupon/index-coupon.html">Qu·∫£n l√Ω m√£ gi·∫£m
                    gi√°</a></li>
              </ul>
              <ul class="nav flex-column sub-menu">
                <li class="nav-item"> <a class="nav-link" href="/Admin/pages/coupon/create-coupon.html">Th√™m m·ªõi m√£ gi·∫£m
                    gi√°</a></li>
              </ul>
            </div>
          </li>

          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#message-basic" aria-expanded="false"
              aria-controls="message-basic">
              <i class="menu-icon mdi mdi-cart-outline"></i>
              <span class="menu-title">Tin nh·∫Øn</span>
              <i class="menu-arrow"></i>
            </a>
            <div class="collapse" id="message-basic">
              <ul class="nav flex-column sub-menu">
                <li class="nav-item"> <a class="nav-link" href="/Admin/pages/message/index-message.html">Ki·ªÉm tra tin
                    nh·∫Øn
                  </a></li>
              </ul>
            </div>
          </li>

        </ul>
      </nav>

      <!-- partial -->
      <div class="main-panel">
        <div class="content-wrapper">
          <div class="row">
            <div class="col-sm-12">
              <div class="home-tab">
                <div class="tab-content tab-content-basic">
                  <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview">

                    <div class="col-lg-12 d-flex flex-row">
                      <div class="col-md-6 col-lg-6 grid-margin stretch-card">
                        <div class="card card-rounded">
                          <div class="card-body">
                            <h4 class="card-title card-title-dash">Kh√°ch H√†ng H√†ng ƒê·∫ßu</h4>
                            <ul id="topCustomersList" class="list-group"></ul>
                          </div>
                        </div>
                      </div>

                      <div class="col-md-6 col-lg-6 grid-margin stretch-card">
                        <div class="card card-rounded">
                          <div class="card-body">
                            <h4 class="card-title card-title-dash">T·ªïng Quan H·ªá Th·ªëng</h4>
                            <p>Ng∆∞·ªùi d√πng: <strong id="totalUsers">0</strong></p>
                            <p>S·∫£n ph·∫©m: <strong id="totalProducts">0</strong> (Ho·∫°t ƒë·ªông: <span
                                id="activeProducts">0</span>)</p>
                            <p>Phi·∫øu gi·∫£m gi√°: <strong id="totalCoupons">0</strong> (Kh·∫£ d·ª•ng: <span
                                id="couponsUsable">0</span>)</p>
                          </div>
                        </div>
                      </div>
                    </div>


                    <div class="row">
                      <div class="col-lg-8 d-flex flex-column">
                        <div class="row flex-grow">
                          <div class="col-12 col-lg-4 col-lg-12 grid-margin stretch-card">
                            <div class="card card-rounded">
                              <div class="card-body">
                                <div class="d-sm-flex justify-content-between align-items-start">
                                  <div>
                                    <h4 class="card-title card-title-dash">Th·ªëng k√™ doanh thu</h4>
                                    <h5 class="card-subtitle card-subtitle-dash">Chi ti·∫øt ƒë∆°n h√†ng v√† doanh thu</h5>
                                  </div>
                                  <div id="performanceLine-legend"></div>
                                </div>

                                <!-- Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng: Doanh thu theo ng√†y -->
                                <div class="chart-container mt-4">
                                  <div class="card">
                                    <div class="card-body">
                                      <h5 class="card-title text-center">üìä Doanh thu theo ng√†y</h5>
                                      <div class="chartjs-wrapper">
                                        <canvas id="ordersChart"></canvas>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Bi·ªÉu ƒë·ªì c·ªôt: S·ªë l∆∞·ª£ng ƒë∆°n h√†ng theo ng√†y -->
                                <div class="chart-container mt-4">
                                  <div class="card">
                                    <div class="card-body">
                                      <h5 class="card-title text-center">üì¶ S·ªë l∆∞·ª£ng ƒë∆°n h√†ng theo ng√†y</h5>
                                      <div class="chartjs-wrapper">
                                        <canvas id="ordersBarChart"></canvas>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>


                              <div class="revenue-summary mt-4">
                                <div class="card text-white bg-info mb-3">
                                  <div class="card-body">
                                    <div class="row">
                                      <div class="col-md-6">
                                        <p class="card-text" style="font-size: 17px;"><strong>üí∞ T·ªïng doanh
                                            thu:</strong> <span id="totalRevenue">0</span> VND</p>
                                        <p class="card-text" style="font-size: 17px;"><strong>üì¶ S·ªë l∆∞·ª£ng ƒë∆°n
                                            h√†ng:</strong> <span id="totalOrders">0</span></p>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>


                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-lg-4 d-flex flex-column">
                        <div class="row flex-grow">


                          <div class="col-md-6 col-lg-12 grid-margin stretch-card">
                            <div class="card card-rounded">
                              <div class="card-body">
                                <div class="row">
                                  <div class="col-lg-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2 mb-sm-0">
                                      <div class="circle-progress-width">
                                        <div id="pendingOrders" class="progressbar-js-circle pr-2"></div>
                                      </div>
                                      <div>
                                        <p class="text-small mb-2">ƒê∆°n H√†ng Ch·ªù X·ª≠ L√Ω</p>
                                        <h4 class="mb-0 fw-bold" id="totalPendingOrders">0</h4>
                                      </div>
                                    </div>
                                  </div>
                                  <div class="col-lg-6">
                                    <div class="d-flex justify-content-between align-items-center">
                                      <div class="circle-progress-width">
                                        <div id="completedOrders" class="progressbar-js-circle pr-2"></div>
                                      </div>
                                      <div>
                                        <p class="text-small mb-2">ƒê∆°n H√†ng Ho√†n Th√†nh</p>
                                        <h4 class="mb-0 fw-bold" id="totalCompletedOrders">0</h4>
                                      </div>
                                    </div>
                                  </div>
                                  <div class="col-lg-12 mt-4">
                                    <canvas id="revenueChart"></canvas>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                    </div>



                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script src="assets/vendors/js/vendor.bundle.base.js"></script>
      <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
      <script src="assets/vendors/chart.js/chart.umd.js"></script>
      <script src="assets/vendors/progressbar.js/progressbar.min.js"></script>
      <script src="assets/js/off-canvas.js"></script>
      <script src="assets/js/template.js"></script>
      <script src="assets/js/settings.js"></script>
      <script src="assets/js/hoverable-collapse.js"></script>
      <script src="assets/js/todolist.js"></script>
      <script src="assets/js/jquery.cookie.js" type="text/javascript"></script>
      <script src="assets/js/dashboard.js"></script>
      <script src="/Admin/assets/js/role.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-gradient"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/2.0.7/countUp.umd.js"></script>



      <script>

        async function fetchTopCustomers() {
          try {
            let response = await fetch("https://localhost:1006/top-customer");
            let customers = await response.json();

            let customerList = document.getElementById("topCustomersList");
            customerList.innerHTML = "";
            customers.forEach(customer => {
              let listItem = document.createElement("li");
              listItem.className = "list-group-item d-flex justify-content-between align-items-center";
              listItem.innerHTML = `
                      <span>${customer.email}</span>
                      <span class="badge bg-primary">${customer.totalSpent.toLocaleString()} VND</span>
                  `;
              customerList.appendChild(listItem);
            });
          } catch (error) {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu kh√°ch h√†ng:", error);
          }
        }

        async function fetchDashboardStats() {
          try {
            let response = await fetch("https://localhost:1006/dashboard-statistics");
            let stats = await response.json();

            document.getElementById("totalUsers").textContent = stats.totalUsers;
            document.getElementById("totalProducts").textContent = stats.totalProducts;
            document.getElementById("activeProducts").textContent = stats.activeProducts;
            document.getElementById("totalCoupons").textContent = stats.totalCoupons;
            document.getElementById("couponsUsable").textContent = stats.couponsUsable;
          } catch (error) {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu th·ªëng k√™:", error);
          }
        }

        // G·ªçi API khi trang t·∫£i xong
        document.addEventListener("DOMContentLoaded", () => {
          fetchTopCustomers();
          fetchDashboardStats();
        });


        async function fetchOrders() {
          try {
            const response = await fetch("https://localhost:1006/get-orders");
            const orders = await response.json();

            // Object nh√≥m d·ªØ li·ªáu theo ng√†y
            const revenueByDay = {};
            const orderCountByDay = {};
            let totalRevenue = 0;

            orders.forEach(order => {
              const date = order.createdAt.split("T")[0]; // YYYY-MM-DD

              // Nh√≥m theo ng√†y
              if (!revenueByDay[date]) {
                revenueByDay[date] = 0;
                orderCountByDay[date] = 0;
              }
              revenueByDay[date] += order.totalPrice;
              orderCountByDay[date] += 1;
              totalRevenue += order.totalPrice;
            });

            // S·∫Øp x·∫øp ng√†y theo th·ª© t·ª± tƒÉng d·∫ßn
            const days = Object.keys(revenueByDay).sort();
            const revenueData = days.map(date => revenueByDay[date]);
            const orderCountData = days.map(date => orderCountByDay[date]);

            // Hi·ªÉn th·ªã th√¥ng tin t·ªïng quan
            document.getElementById("totalRevenue").textContent = totalRevenue.toLocaleString("vi-VN");
            document.getElementById("totalOrders").textContent = orders.length;

            // L·∫•y canvas
            const ctxLine = document.getElementById("ordersChart").getContext("2d");
            const ctxBar = document.getElementById("ordersBarChart").getContext("2d");

            // X√≥a bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
            if (window.ordersChart instanceof Chart) {
              window.ordersChart.destroy();
            }
            if (window.ordersBarChart instanceof Chart) {
              window.ordersBarChart.destroy();
            }

            // Bi·ªÉu ƒë·ªì doanh thu theo ng√†y (Line Chart)
            window.ordersChart = new Chart(ctxLine, {
              type: 'line',
              data: {
                labels: days,
                datasets: [{
                  label: 'Doanh thu theo ng√†y (VND)',
                  data: revenueData,
                  borderColor: '#007bff',
                  backgroundColor: "rgba(0, 123, 255, 0.3)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.3,
                  pointRadius: 6,
                  pointBackgroundColor: '#fff',
                  pointBorderColor: '#007bff',
                  pointBorderWidth: 2,
                  pointHoverRadius: 8,
                  pointHoverBackgroundColor: '#007bff'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: {
                    title: { display: true, text: 'Ng√†y', font: { size: 14, weight: 'bold' } }
                  },
                  y: {
                    title: { display: true, text: 'Doanh thu (VND)', font: { size: 14, weight: 'bold' } }
                  }
                }
              }
            });

            // Bi·ªÉu ƒë·ªì s·ªë ƒë∆°n h√†ng theo ng√†y (Bar Chart)
            window.ordersBarChart = new Chart(ctxBar, {
              type: 'bar',
              data: {
                labels: days,
                datasets: [{
                  label: 'S·ªë ƒë∆°n h√†ng theo ng√†y',
                  data: orderCountData,
                  backgroundColor: "rgba(255, 99, 132, 0.6)",
                  borderColor: "rgba(255, 99, 132, 1)",
                  borderWidth: 2
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: {
                    title: { display: true, text: 'Ng√†y', font: { size: 14, weight: 'bold' } }
                  },
                  y: {
                    title: { display: true, text: 'S·ªë ƒë∆°n h√†ng', font: { size: 14, weight: 'bold' } },
                    beginAtZero: true
                  }
                },
                plugins: {
                  legend: {
                    position: 'top',
                    labels: { font: { size: 14, weight: 'bold' } }
                  }
                }
              }
            });

          } catch (error) {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu:", error);
          }
        }

        // G·ªçi h√†m ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì
        fetchOrders();






        async function fetchOrderStatistics() {
          try {
            const response = await fetch("https://localhost:1006/order-statistics");
            const data = await response.json();

            // C·∫≠p nh·∫≠t s·ªë li·ªáu v√†o HTML
            document.getElementById("totalOrders").innerText = data.totalOrders;
            document.getElementById("totalRevenue").innerText = data.totalRevenue.toLocaleString() + " VND";
            document.getElementById("totalPendingOrders").innerText = data.totalPendingOrders;
            document.getElementById("totalCompletedOrders").innerText = data.totalCompletedOrders;

            // V·∫Ω bi·ªÉu ƒë·ªì doanh thu h√†ng th√°ng
            renderRevenueChart(data.monthlyRevenues);
          } catch (error) {
            console.error("Error fetching order statistics:", error);
          }
        }

        // H√†m v·∫Ω bi·ªÉu ƒë·ªì doanh thu
        function renderRevenueChart(monthlyRevenues) {
          const ctx = document.getElementById("revenueChart").getContext("2d");

          const months = monthlyRevenues.map(item => `Th√°ng ${item.month}`);
          const revenues = monthlyRevenues.map(item => item.totalRevenue);

          new Chart(ctx, {
            type: "bar",
            data: {
              labels: months,
              datasets: [{
                label: "Monthly Revenue",
                data: revenues,
                backgroundColor: "rgba(54, 162, 235, 0.6)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }

        // G·ªçi API khi trang t·∫£i xong
        document.addEventListener("DOMContentLoaded", fetchOrderStatistics);


        document.addEventListener("DOMContentLoaded", function () {
          const greetingElement = document.getElementById("greeting");
          const currentHour = new Date().getHours();
          let greetingMessage = "Good Morning";

          if (currentHour >= 12 && currentHour < 18) {
            greetingMessage = "Good Afternoon";
          } else if (currentHour >= 18 || currentHour < 5) {
            greetingMessage = "Good Evening";
          }

          greetingElement.innerHTML = `${greetingMessage}, HHT <span style="color: #5eba24;">Pharmacy</span>`;
        });
      </script>
</body>

</html>